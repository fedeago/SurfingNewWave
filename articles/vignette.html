<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bioc2021 NewWave workshop • SurfingNewWave</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Bioc2021 NewWave workshop">
<meta property="og:description" content="SurfingNewWave">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-93043521-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-93043521-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SurfingNewWave</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/vignette.html">Bioc2021 NewWave workshop</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/fedeago/SurfingNewWave">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="vignette_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Bioc2021 NewWave workshop</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/fedeago/SurfingNewWave/blob/master/vignettes/vignette.Rmd"><code>vignettes/vignette.Rmd</code></a></small>
      <div class="hidden name"><code>vignette.Rmd</code></div>

    </div>

    
    
<div id="introduction-to-newwave" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction-to-newwave" class="anchor"></a>Introduction to NewWave</h1>
<p>Bioc 2021: 4-6 August</p>
<div id="workshop-description" class="section level2">
<h2 class="hasAnchor">
<a href="#workshop-description" class="anchor"></a>Workshop Description</h2>
<p>The fast development of single cell sequencing technologies in the recent years has generated a gap between the throughput of the experiments and the capability of analizing these generated data. In this package, we implement mini-batch stochastic gradient descent and the possibility to work with HDF5 files. We decided to use a negative binomial model following the observation that droplet sequencing technologies do not induce zero inflation in the data. Thanks to these improvements and the possibility of massively parallelize the estimation process using PSOCK clusters, we are able to speed up the computation.</p>
<div id="r-bioconductor-packages-used" class="section level3">
<h3 class="hasAnchor">
<a href="#r-bioconductor-packages-used" class="anchor"></a><em>R</em> / <em>Bioconductor</em> packages used</h3>
<ul>
<li>SharedObject</li>
<li>DelayedArray</li>
<li>SingleCellExperiment</li>
<li>splatter</li>
<li>TENxBrainData</li>
</ul>
</div>
</div>
<div id="workshop-goals-and-objectives" class="section level2">
<h2 class="hasAnchor">
<a href="#workshop-goals-and-objectives" class="anchor"></a>Workshop goals and objectives</h2>
<p>In this workshop I am going to show how to use NewWave with different object and how to choose the optimal parameter related to your hardware.</p>
</div>
</div>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>NewWave assumes a negative binomial distribution where the mean parameter is related to each single observation while the dispersion parameter can be equal for all observation or related to each single gene.</p>
<p><span class="math display">\[Y_{ij} \sim NB(\mu_{ij},\theta_j)\]</span> And this is how the parameters are estimated:</p>
<p><span class="math display">\[\ln(\mu_{ij}) = \Big(X\beta + (V\gamma)^T + W\alpha \Big)_{ij} \]</span> <span class="math display">\[\ln(\theta_j)   = \zeta_j\]</span> These are the steps used for estimate parameters :</p>
<ul>
<li>Initialization of regression parameters parameters using ridge regression, and low-rank rapresentation with PCA.</li>
<li>Optimization of dispersion parameters, if genewise massively parallelizable.</li>
<li>Optimization of the cell-related parameters, using MLE, massively parallelizable.</li>
<li>Optimization of the gene-related parameters, using MLE, massive parallelizable.</li>
</ul>
<p>While the initialization is done only once at the beginnig of the process the other three steps are done iteratively till convergence.</p>
<p>In order to reduce the memory consumption it uses a PSOCK cluster combined with the R package SharedObject that allow to share a matrix between different cores avoiding memory duplication. Thanks to that we can massively parallelize the estimation process with huge benefit in terms of time consumption. We can reduce even more the time consumption using some mini batch approaches on the different steps of the optimization.</p>
<p>I am going to show how to use NewWave with example data generated with Splatter.</p>
<p>Splatter is a R package designed to generate single cell transcriptomic data with a high level of customization.</p>
<p>In our implementation we want a batch effect to be corrected, the additionals batch parameters are setted in order to create more complex batch effect.</p>
<p>You can think to the group as a cell type, we will use those group to test the resulted low dimensional representation through a cluster analysis.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span>
  <span class="op">{</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">SingleCellExperiment</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Oshlack/splatter">splatter</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">irlba</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jkrijthe/Rtsne">Rtsne</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mclust-org.github.io/mclust/">mclust</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">NewWave</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/splatter/man/newParams.html">newSplatParams</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">N</span><span class="op">=</span><span class="fl">1000</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/splatter/man/splatSimulate.html">splatSimulateGroups</a></span><span class="op">(</span><span class="va">params</span>,batchCells<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">N</span><span class="op">/</span><span class="fl">2</span>,<span class="va">N</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,
                           group.prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">10</span><span class="op">)</span>,
                           de.prob <span class="op">=</span> <span class="fl">0.2</span>,
                           batch.facLoc <span class="op">=</span> <span class="fl">2</span>,
                           batch.facScale <span class="op">=</span> <span class="fl">1</span>,
                           verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> </code></pre></div>
<p>The resault of splatter is a SingleCellExperiment with the generated data in the assays counts.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 10000 1000 
## metadata(1): Params
## assays(6): BatchCellMeans BaseCellMeans ... TrueCounts counts
## rownames(10000): Gene1 Gene2 ... Gene9999 Gene10000
## rowData names(16): Gene BaseGeneMean ... DEFacGroup9 DEFacGroup10
## colnames(1000): Cell1 Cell2 ... Cell999 Cell1000
## colData names(4): Cell Batch Group ExpLibSize
## reducedDimNames(0):
## mainExpName: NULL
## altExpNames(0):</code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html">counts</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "matrix" "array"</code></pre>
<p>As you can see we have the number of cell that we choose(N=500) an 10 000 genes. For this workshop we will choose only the 1000 most variable genes.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hvg</span> <span class="op">&lt;-</span> <span class="fu">rowVars</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html">counts</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">hvg</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html">counts</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">hvg</span>,decreasing<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">500</span><span class="op">]</span>,<span class="op">]</span></code></pre></div>
<p>In a SingleCellExperiment the colData slot contains the sample level metadata. In our situation there are two important variable, Batch and Group.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">colData</span><span class="op">(</span><span class="va">data</span><span class="op">)</span></code></pre></div>
<pre><code>## DataFrame with 1000 rows and 4 columns
##                 Cell       Batch    Group ExpLibSize
##          &lt;character&gt; &lt;character&gt; &lt;factor&gt;  &lt;numeric&gt;
## Cell1          Cell1      Batch1  Group6     57952.5
## Cell2          Cell2      Batch1  Group5     57381.8
## Cell3          Cell3      Batch1  Group8     71355.3
## Cell4          Cell4      Batch1  Group10    46996.7
## Cell5          Cell5      Batch1  Group3     44746.5
## ...              ...         ...      ...        ...
## Cell996      Cell996      Batch2   Group9    45118.0
## Cell997      Cell997      Batch2   Group3    42245.2
## Cell998      Cell998      Batch2   Group4    66518.3
## Cell999      Cell999      Batch2   Group4    65121.5
## Cell1000    Cell1000      Batch2   Group8    71415.2</code></pre>
<p><strong>IMPORTANT:</strong> For batch effect removal the batch variable must be a factor</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span><span class="op">$</span><span class="va">Batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Batch</span><span class="op">)</span></code></pre></div>
<p>NewWave takes as input raw data, not normalized. So now we have all the object needed to start.</p>
<p>We can see the how the cells are distributed between group and batch.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/irlba/man/prcomp_irlba.html">prcomp_irlba</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html">counts</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>,n<span class="op">=</span><span class="fl">10</span><span class="op">)</span>
<span class="va">plot_data</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Rtsne/man/Rtsne.html">Rtsne</a></span><span class="op">(</span><span class="va">pca</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plot_data</span><span class="op">$</span><span class="va">batch</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">Batch</span>
<span class="va">plot_data</span><span class="op">$</span><span class="va">group</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">Group</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">plot_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">X1</span>,y<span class="op">=</span><span class="va">X2</span>,col<span class="op">=</span><span class="va">group</span>, shape<span class="op">=</span><span class="va">batch</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>Just for a later comparison we can see the performance of clustering on PCA low dimensional representation.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html">kmeans</a></span><span class="op">(</span><span class="va">pca</span><span class="op">$</span><span class="va">x</span>, <span class="fl">10</span><span class="op">)</span>

<span class="fu"><a href="https://mclust-org.github.io/mclust/reference/adjustedRandIndex.html">adjustedRandIndex</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">$</span><span class="va">cluster</span>, <span class="va">data</span><span class="op">$</span><span class="va">Group</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.03827329</code></pre>
<p>There is a clear batch effect between the cells.</p>
<p>Let’s try to correct it.</p>
</div>
<div id="newwave" class="section level1">
<h1 class="hasAnchor">
<a href="#newwave" class="anchor"></a>NewWave</h1>
<p>I am going to show different implementation and the suggested way to use them with the given hardware.</p>
<p>Some basic advise:</p>
<ul>
<li>Verbose option has default FALSE, in this vignette I will change it for explanatory intentions, don’t do it with big dataset because it can sensibly slower the computation</li>
<li>There are no concern about the dimension of mini-batches, I always used the 10% of the observations</li>
</ul>
<div id="standard-usage" class="section level2">
<h2 class="hasAnchor">
<a href="#standard-usage" class="anchor"></a>Standard usage</h2>
<p>I am going to present the stadard implementation of NewWave, it uses 1 cores, it estimates a dispersion parameters equal for all observation and uses all the observation in the estimation process.</p>
<p>The K parameter represents the number of dimension of the latent rapresentation.</p>
<p>The X parameter is used to indicates which variable represent the batch effect, in the same way can be inserted other cell-related variable and if you need some gene related variable those can be inserted in V.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/NewWave/man/newWave.html">newWave</a></span><span class="op">(</span><span class="va">data</span>, X <span class="op">=</span> <span class="st">"~Batch"</span>, K<span class="op">=</span><span class="fl">10</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## Time of setup
##    user  system elapsed 
##   0.009   0.000   0.219 
## Time of initialization
##    user  system elapsed 
##   0.043   0.012   0.670</code></pre>
<pre><code>## Iteration 1</code></pre>
<pre><code>## penalized log-likelihood = -2037443.32678582</code></pre>
<pre><code>## Time of dispersion optimization
##    user  system elapsed 
##   0.952   0.060   0.986</code></pre>
<pre><code>## after optimize dispersion = -1761735.2486796</code></pre>
<pre><code>## Time of right optimization
##    user  system elapsed 
##   0.001   0.000   8.324</code></pre>
<pre><code>## after right optimization= -1712568.56031997</code></pre>
<pre><code>## after orthogonalization = -1712564.39471734</code></pre>
<pre><code>## Time of left optimization
##    user  system elapsed 
##   0.012   0.009   8.692</code></pre>
<pre><code>## after left optimization= -1706344.70711164</code></pre>
<pre><code>## after orthogonalization = -1706344.1141707</code></pre>
<pre><code>## Iteration 2</code></pre>
<pre><code>## penalized log-likelihood = -1706344.1141707</code></pre>
<pre><code>## Time of dispersion optimization
##    user  system elapsed 
##   1.104   0.060   1.057</code></pre>
<pre><code>## after optimize dispersion = -1705180.42919711</code></pre>
<pre><code>## Time of right optimization
##    user  system elapsed 
##   0.001   0.000   8.785</code></pre>
<pre><code>## after right optimization= -1704625.65181094</code></pre>
<pre><code>## after orthogonalization = -1704625.5891099</code></pre>
<pre><code>## Time of left optimization
##    user  system elapsed 
##   0.008   0.016   9.361</code></pre>
<pre><code>## after left optimization= -1704412.41079452</code></pre>
<pre><code>## after orthogonalization = -1704412.39422238</code></pre>
<pre><code>## Iteration 3</code></pre>
<pre><code>## penalized log-likelihood = -1704412.39422238</code></pre>
<pre><code>## Time of dispersion optimization
##    user  system elapsed 
##   1.114   0.053   1.060</code></pre>
<pre><code>## after optimize dispersion = -1704408.57483847</code></pre>
<pre><code>## Time of right optimization
##    user  system elapsed 
##   0.001   0.000   7.891</code></pre>
<pre><code>## after right optimization= -1704304.35629273</code></pre>
<pre><code>## after orthogonalization = -1704304.3501141</code></pre>
<pre><code>## Time of left optimization
##    user  system elapsed 
##   0.013   0.008   9.027</code></pre>
<pre><code>## after left optimization= -1704239.61820607</code></pre>
<pre><code>## after orthogonalization = -1704239.61757635</code></pre>
<pre><code>## Iteration 4</code></pre>
<pre><code>## penalized log-likelihood = -1704239.61757635</code></pre>
<pre><code>## Time of dispersion optimization
##    user  system elapsed 
##   1.104   0.060   1.058</code></pre>
<pre><code>## after optimize dispersion = -1704239.48789269</code></pre>
<pre><code>## Time of right optimization
##    user  system elapsed 
##   0.001   0.000   7.225</code></pre>
<pre><code>## after right optimization= -1704191.17432547</code></pre>
<pre><code>## after orthogonalization = -1704191.17123847</code></pre>
<pre><code>## Time of left optimization
##    user  system elapsed 
##   0.021   0.008   8.688</code></pre>
<pre><code>## after left optimization= -1704154.6650406</code></pre>
<pre><code>## after orthogonalization = -1704154.66461525</code></pre>
<p>In order to make it faster you can increase the number of cores using <code>children</code> parameter:</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/NewWave/man/newWave.html">newWave</a></span><span class="op">(</span><span class="va">data</span>,X <span class="op">=</span> <span class="st">"~Batch"</span>, K<span class="op">=</span><span class="fl">10</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span>, children<span class="op">=</span><span class="fl">2</span><span class="op">)</span></code></pre></div>
<pre><code>## Time of setup
##    user  system elapsed 
##   0.009   0.000   0.224 
## Time of initialization
##    user  system elapsed 
##   0.040   0.012   0.529</code></pre>
<pre><code>## Iteration 1</code></pre>
<pre><code>## penalized log-likelihood = -2037443.32678783</code></pre>
<pre><code>## Time of dispersion optimization
##    user  system elapsed 
##   0.956   0.016   0.939</code></pre>
<pre><code>## after optimize dispersion = -1761735.24876843</code></pre>
<pre><code>## Time of right optimization
##    user  system elapsed 
##   0.001   0.000   8.741</code></pre>
<pre><code>## after right optimization= -1712568.56030678</code></pre>
<pre><code>## after orthogonalization = -1712564.39470413</code></pre>
<pre><code>## Time of left optimization
##    user  system elapsed 
##   0.018   0.021   4.644</code></pre>
<pre><code>## after left optimization= -1706344.70720047</code></pre>
<pre><code>## after orthogonalization = -1706344.11425915</code></pre>
<pre><code>## Iteration 2</code></pre>
<pre><code>## penalized log-likelihood = -1706344.11425915</code></pre>
<pre><code>## Time of dispersion optimization
##    user  system elapsed 
##   1.133   0.040   1.066</code></pre>
<pre><code>## after optimize dispersion = -1705180.42927052</code></pre>
<pre><code>## Time of right optimization
##    user  system elapsed 
##   0.001   0.000   9.070</code></pre>
<pre><code>## after right optimization= -1704625.65126335</code></pre>
<pre><code>## after orthogonalization = -1704625.58856465</code></pre>
<pre><code>## Time of left optimization
##    user  system elapsed 
##   0.015   0.004   4.727</code></pre>
<pre><code>## after left optimization= -1704412.43028258</code></pre>
<pre><code>## after orthogonalization = -1704412.41368037</code></pre>
<pre><code>## Iteration 3</code></pre>
<pre><code>## penalized log-likelihood = -1704412.41368037</code></pre>
<pre><code>## Time of dispersion optimization
##    user  system elapsed 
##   1.123   0.040   1.056</code></pre>
<pre><code>## after optimize dispersion = -1704408.59417411</code></pre>
<pre><code>## Time of right optimization
##    user  system elapsed 
##   0.001   0.001   8.529</code></pre>
<pre><code>## after right optimization= -1704304.37626503</code></pre>
<pre><code>## after orthogonalization = -1704304.37009586</code></pre>
<pre><code>## Time of left optimization
##    user  system elapsed 
##   0.021   0.016   4.665</code></pre>
<pre><code>## after left optimization= -1704239.61228352</code></pre>
<pre><code>## after orthogonalization = -1704239.61166838</code></pre>
<pre><code>## Iteration 4</code></pre>
<pre><code>## penalized log-likelihood = -1704239.61166838</code></pre>
<pre><code>## Time of dispersion optimization
##    user  system elapsed 
##   1.102   0.080   1.076</code></pre>
<pre><code>## after optimize dispersion = -1704239.48238823</code></pre>
<pre><code>## Time of right optimization
##    user  system elapsed 
##   0.002   0.000   7.979</code></pre>
<pre><code>## after right optimization= -1704191.06718292</code></pre>
<pre><code>## after orthogonalization = -1704191.06410209</code></pre>
<pre><code>## Time of left optimization
##    user  system elapsed 
##   0.015   0.020   4.468</code></pre>
<pre><code>## after left optimization= -1704154.57436112</code></pre>
<pre><code>## after orthogonalization = -1704154.57393398</code></pre>
</div>
<div id="commonwise-dispersion-and-minibatch-approaches" class="section level2">
<h2 class="hasAnchor">
<a href="#commonwise-dispersion-and-minibatch-approaches" class="anchor"></a>Commonwise dispersion and minibatch approaches</h2>
<p>If you do not have an high number of cores to run newWave this is the fastest way to run.</p>
<p>Each of these three steps can be accelerated using mini batch, the number of observation is settled with these parameters:</p>
<ul>
<li>n_gene_disp : Number of genes to use in the dispersion optimization</li>
<li>n_cell_par : Number of cells to use in the cells related parameters optimization</li>
<li>n_gene_par : Number of genes to use in the genes related parameters optimization</li>
</ul>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/NewWave/man/newWave.html">newWave</a></span><span class="op">(</span><span class="va">data</span>,X <span class="op">=</span> <span class="st">"~Batch"</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span>,K<span class="op">=</span><span class="fl">10</span>, children<span class="op">=</span><span class="fl">2</span>,
                n_gene_disp <span class="op">=</span> <span class="fl">100</span>, n_gene_par <span class="op">=</span> <span class="fl">100</span>, n_cell_par <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></code></pre></div>
<pre><code>## Time of setup
##    user  system elapsed 
##   0.010   0.000   0.226 
## Time of initialization
##    user  system elapsed 
##   0.043   0.008   0.522</code></pre>
<pre><code>## Iteration 1</code></pre>
<pre><code>## penalized log-likelihood = -2037443.32678676</code></pre>
<pre><code>## Time of dispersion optimization
##    user  system elapsed 
##   0.951   0.020   0.936</code></pre>
<pre><code>## after optimize dispersion = -1761735.2486814</code></pre>
<pre><code>## Time of right optimization
##    user  system elapsed 
##   0.001   0.000   9.403</code></pre>
<pre><code>## after right optimization= -1712568.56031708</code></pre>
<pre><code>## after orthogonalization = -1712564.39471445</code></pre>
<pre><code>## Time of left optimization
##    user  system elapsed 
##   0.021   0.016   4.619</code></pre>
<pre><code>## after left optimization= -1706344.70711463</code></pre>
<pre><code>## after orthogonalization = -1706344.11417368</code></pre>
<pre><code>## Iteration 2</code></pre>
<pre><code>## penalized log-likelihood = -1706344.11417368</code></pre>
<pre><code>## Time of dispersion optimization
##    user  system elapsed 
##   0.400   0.044   0.336</code></pre>
<pre><code>## after optimize dispersion = -1705180.85227346</code></pre>
<pre><code>## Time of right optimization
##    user  system elapsed 
##   0.001   0.000   1.736</code></pre>
<pre><code>## after right optimization= -1705062.77727947</code></pre>
<pre><code>## after orthogonalization = -1705062.76520226</code></pre>
<pre><code>## Time of left optimization
##    user  system elapsed 
##   0.011   0.008   0.450</code></pre>
<pre><code>## after left optimization= -1705057.33296447</code></pre>
<pre><code>## after orthogonalization = -1705057.33284761</code></pre>
<pre><code>## Iteration 3</code></pre>
<pre><code>## penalized log-likelihood = -1705057.33284761</code></pre>
<pre><code>## Time of dispersion optimization
##    user  system elapsed 
##   0.387   0.056   0.337</code></pre>
<pre><code>## after optimize dispersion = -1705057.33284761</code></pre>
<pre><code>## Time of right optimization
##    user  system elapsed 
##   0.001   0.000   1.714</code></pre>
<pre><code>## after right optimization= -1704968.66073054</code></pre>
<pre><code>## after orthogonalization = -1704968.65620367</code></pre>
<pre><code>## Time of left optimization
##    user  system elapsed 
##   0.019   0.019   0.471</code></pre>
<pre><code>## after left optimization= -1704959.27708761</code></pre>
<pre><code>## after orthogonalization = -1704959.27678503</code></pre>
</div>
<div id="genewise-dispersion-mini-batch" class="section level2">
<h2 class="hasAnchor">
<a href="#genewise-dispersion-mini-batch" class="anchor"></a>Genewise dispersion mini-batch</h2>
<p>If you have a lot of core disposable or you want to estimate a genewise dispersion parameter this is the fastest configuration:</p>
<p><strong>IMPORTANT</strong>:do not use n_gene_disp in this case, it will slower the computation.</p>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/NewWave/man/newWave.html">newWave</a></span><span class="op">(</span><span class="va">data</span>,X <span class="op">=</span> <span class="st">"~Batch"</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span>,K<span class="op">=</span><span class="fl">10</span>, children<span class="op">=</span><span class="fl">2</span>,
                n_gene_par <span class="op">=</span> <span class="fl">100</span>, n_cell_par <span class="op">=</span> <span class="fl">100</span>, commondispersion <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<pre><code>## Time of setup
##    user  system elapsed 
##   0.009   0.000   0.224 
## Time of initialization
##    user  system elapsed 
##   0.043   0.008   0.489</code></pre>
<pre><code>## Iteration 1</code></pre>
<pre><code>## penalized log-likelihood = -2037443.32678603</code></pre>
<pre><code>## Time of dispersion optimization
##    user  system elapsed 
##   0.937   0.028   0.929</code></pre>
<pre><code>## after optimize dispersion = -1761735.24867292</code></pre>
<pre><code>## Time of right optimization
##    user  system elapsed 
##   0.001   0.000   8.749</code></pre>
<pre><code>## after right optimization= -1712568.5603126</code></pre>
<pre><code>## after orthogonalization = -1712564.39470996</code></pre>
<pre><code>## Time of left optimization
##    user  system elapsed 
##   0.008   0.004   4.612</code></pre>
<pre><code>## after left optimization= -1706344.70711184</code></pre>
<pre><code>## after orthogonalization = -1706344.11417089</code></pre>
<pre><code>## Iteration 2</code></pre>
<pre><code>## penalized log-likelihood = -1706344.11417089</code></pre>
<pre><code>## Time of dispersion optimization
##    user  system elapsed 
##   0.116   0.045   0.811</code></pre>
<pre><code>## after optimize dispersion = -1699482.96298282</code></pre>
<pre><code>## Time of right optimization
##    user  system elapsed 
##   0.001   0.000   2.066</code></pre>
<pre><code>## after right optimization= -1699400.0500167</code></pre>
<pre><code>## after orthogonalization = -1699400.04246384</code></pre>
<pre><code>## Time of left optimization
##    user  system elapsed 
##   0.005   0.004   0.520</code></pre>
<pre><code>## after left optimization= -1699353.22556958</code></pre>
<pre><code>## after orthogonalization = -1699353.22518741</code></pre>
<pre><code>## Iteration 3</code></pre>
<pre><code>## penalized log-likelihood = -1699353.22518741</code></pre>
<pre><code>## Time of dispersion optimization
##    user  system elapsed 
##   0.125   0.052   0.384</code></pre>
<pre><code>## after optimize dispersion = -1699353.44753586</code></pre>
<pre><code>## Time of right optimization
##    user  system elapsed 
##   0.001   0.000   1.846</code></pre>
<pre><code>## after right optimization= -1699271.2181217</code></pre>
<pre><code>## after orthogonalization = -1699271.20974833</code></pre>
<pre><code>## Time of left optimization
##    user  system elapsed 
##   0.010   0.005   0.506</code></pre>
<pre><code>## after left optimization= -1699230.35463811</code></pre>
<pre><code>## after orthogonalization = -1699230.35387826</code></pre>
<p>This way will store the latent representation in the <code>reducedDim</code> slot.</p>
<p>Now I can use the latent dimension representation for visualization purpose:</p>
<div class="sourceCode" id="cb164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">latent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html">reducedDim</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>

<span class="va">tsne_latent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Rtsne/man/Rtsne.html">Rtsne</a></span><span class="op">(</span><span class="va">latent</span><span class="op">)</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span>
<span class="va">tsne_latent</span><span class="op">$</span><span class="va">batch</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">Batch</span>
<span class="va">tsne_latent</span><span class="op">$</span><span class="va">group</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">Group</span></code></pre></div>
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">tsne_latent</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">X1</span>,y<span class="op">=</span><span class="va">X2</span>,col<span class="op">=</span><span class="va">group</span>, shape<span class="op">=</span><span class="va">batch</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="vignette_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<p>or for clustering:</p>
<div class="sourceCode" id="cb166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html">kmeans</a></span><span class="op">(</span><span class="va">latent</span>, <span class="fl">10</span><span class="op">)</span>

<span class="fu"><a href="https://mclust-org.github.io/mclust/reference/adjustedRandIndex.html">adjustedRandIndex</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">$</span><span class="va">cluster</span>, <span class="va">data</span><span class="op">$</span><span class="va">Group</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>if we want to obtain more information about the model we can run <code>newFit</code> that has exactly the same parameters</p>
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/NewWave/man/newFit.html">newFit</a></span><span class="op">(</span><span class="va">data</span>,X <span class="op">=</span> <span class="st">"~Batch"</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span>,K<span class="op">=</span><span class="fl">10</span>, children<span class="op">=</span><span class="fl">2</span>,
                n_gene_par <span class="op">=</span> <span class="fl">100</span>, n_cell_par <span class="op">=</span> <span class="fl">100</span>, commondispersion <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<pre><code>## Time of setup
##    user  system elapsed 
##   0.010   0.000   0.238 
## Time of initialization
##    user  system elapsed 
##   0.040   0.012   0.477</code></pre>
<pre><code>## Iteration 1</code></pre>
<pre><code>## penalized log-likelihood = -2037443.326783</code></pre>
<pre><code>## Time of dispersion optimization
##    user  system elapsed 
##   0.952   0.012   0.930</code></pre>
<pre><code>## after optimize dispersion = -1761735.24865698</code></pre>
<pre><code>## Time of right optimization
##    user  system elapsed 
##   0.002   0.000   8.822</code></pre>
<pre><code>## after right optimization= -1712568.56034132</code></pre>
<pre><code>## after orthogonalization = -1712564.39473892</code></pre>
<pre><code>## Time of left optimization
##    user  system elapsed 
##   0.010   0.009   4.588</code></pre>
<pre><code>## after left optimization= -1706344.70714655</code></pre>
<pre><code>## after orthogonalization = -1706344.11420639</code></pre>
<pre><code>## Iteration 2</code></pre>
<pre><code>## penalized log-likelihood = -1706344.11420639</code></pre>
<pre><code>## Time of dispersion optimization
##    user  system elapsed 
##   0.128   0.032   0.807</code></pre>
<pre><code>## after optimize dispersion = -1699482.96434586</code></pre>
<pre><code>## Time of right optimization
##    user  system elapsed 
##   0.002   0.000   2.149</code></pre>
<pre><code>## after right optimization= -1699381.98092146</code></pre>
<pre><code>## after orthogonalization = -1699381.97676572</code></pre>
<pre><code>## Time of left optimization
##    user  system elapsed 
##   0.008   0.011   0.524</code></pre>
<pre><code>## after left optimization= -1699334.17437149</code></pre>
<pre><code>## after orthogonalization = -1699334.17348936</code></pre>
<pre><code>## Iteration 3</code></pre>
<pre><code>## penalized log-likelihood = -1699334.17348936</code></pre>
<pre><code>## Time of dispersion optimization
##    user  system elapsed 
##   0.131   0.044   0.391</code></pre>
<pre><code>## after optimize dispersion = -1699334.40019485</code></pre>
<pre><code>## Time of right optimization
##    user  system elapsed 
##   0.001   0.000   1.811</code></pre>
<pre><code>## after right optimization= -1699265.69728246</code></pre>
<pre><code>## after orthogonalization = -1699265.69297324</code></pre>
<pre><code>## Time of left optimization
##    user  system elapsed 
##   0.009   0.004   0.520</code></pre>
<pre><code>## after left optimization= -1699218.8591713</code></pre>
<pre><code>## after orthogonalization = -1699218.8586599</code></pre>
<p>The result of newFit is an object of class newmodel where are stored all the estimated parameter seen in the introduction.</p>
<div class="sourceCode" id="cb200"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># View(par)</span></code></pre></div>
<p>With this object we can also compute the AIC and the BIC of the model.</p>
<div class="sourceCode" id="cb201"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/NewWave/man/newAIC.html">newAIC</a></span><span class="op">(</span><span class="va">par</span>, <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html">counts</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 3433743</code></pre>
<div class="sourceCode" id="cb203"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/NewWave/man/newBIC.html">newBIC</a></span><span class="op">(</span><span class="va">par</span>, <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html">counts</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 3541713</code></pre>
</div>
</div>
<div id="newwave-on-delayedarray" class="section level1">
<h1 class="hasAnchor">
<a href="#newwave-on-delayedarray" class="anchor"></a>NewWave on DelayedArray</h1>
<p>In this package we can find a huge single cell dataset made by 1.3 M cell and 27 K genes.</p>
<p>Thanks to the hdf5 format that we can use trougth the DelayedArray framework this dataset is not on our RAM but it can be read and used anyway.</p>
<div class="sourceCode" id="cb205"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">TENxBrainData</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb206"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tenx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/TENxBrainData/man/TENxBrainData.html">TENxBrainData</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## snapshotDate(): 2021-07-30</code></pre>
<pre><code>## see ?TENxBrainData and browseVignettes('TENxBrainData') for documentation</code></pre>
<pre><code>## downloading 1 resources</code></pre>
<pre><code>## retrieving 1 resource</code></pre>
<pre><code>## loading from cache</code></pre>
<p>Let’s see how is made this SingleCellExperiment</p>
<div class="sourceCode" id="cb212"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tenx</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 27998 1306127 
## metadata(0):
## assays(1): counts
## rownames: NULL
## rowData names(2): Ensembl Symbol
## colnames(1306127): AAACCTGAGATAGGAG-1 AAACCTGAGCGGCTTC-1 ...
##   TTTGTCAGTTAAAGTG-133 TTTGTCATCTGAAAGA-133
## colData names(4): Barcode Sequence Library Mouse
## reducedDimNames(0):
## mainExpName: NULL
## altExpNames(0):</code></pre>
<p>It has the slot counts were the date are stored exaclty how is needed by NewWave but in this case we do not have the batch effect and so we will only reduce the dimensionality of the dataset.</p>
<p>Despite of the huge dimension of the dataset it’s memory size is really small:</p>
<div class="sourceCode" id="cb214"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html">object.size</a></span><span class="op">(</span><span class="va">tenx</span><span class="op">)</span></code></pre></div>
<pre><code>## 304126712 bytes</code></pre>
<p>only 304 MB.</p>
<p>This is possible because the counts slot is not a matrix.</p>
<div class="sourceCode" id="cb216"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html">counts</a></span><span class="op">(</span><span class="va">tenx</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "DelayedMatrix"
## attr(,"package")
## [1] "DelayedArray"</code></pre>
<p>In order to manage this type of file NewWave uses a set of proper method with some strength and some weakness.</p>
<p>I am not going to show the exact implementation but I will explain how to use NewWave in this situation and why.</p>
<p>The biggest strength of using DelayedArray and HDF5 files is the reduction of the RAM consumption, the cost of that is that we read only a small piece, called chunck, of the dataset every time and so if it is done not properly in can strongly slower the computation especially when it is applied to an iterative optimization such as the one used by NewWave.</p>
<p>For this reason I strongly discourage to set <code>verbose = TRUE</code>, this will force NewWave to read the dataset, chunk by chunk, several time for each iteration.</p>
<p>In this first version of the package this implementation is really effective only when applied on big dataset, let’s say at least 30K cell.</p>
<p>The are some differences with the matrix implementation: * there is a small approximation in the initialization * the estimation of the dispersion parameter is forced to be genewise</p>
<p>The best way to use NewWave in this case is the same we see before but I will not run this code because it would be long.</p>
<div class="sourceCode" id="cb218"><pre class="downlit sourceCode r">
<code class="sourceCode R"> <span class="co"># res4 &lt;- newWave(tenx[1:1000,1:1000], K=10, children=2,n_gene_par = 100, n_cell_par = 100, commondispersion = FALSE, verbose=T )</span></code></pre></div>
<p>The following figures explain the performance of NewWave in this dataset with differents approach, I have always used only the 1000 most variable genes.</p>
<p><img src="time_newWave.png" width="50%"></p>
<p><img src="memory_newWave.png" width="50%"></p>
</div>
<div id="session-information" class="section level1">
<h1 class="hasAnchor">
<a href="#session-information" class="anchor"></a>Session Information</h1>
<div class="sourceCode" id="cb219"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## R version 4.1.0 (2021-05-18)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.2 LTS
## 
## Matrix products: default
## BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=C             
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats4    stats     graphics  grDevices utils     datasets  methods  
## [8] base     
## 
## other attached packages:
##  [1] TENxBrainData_1.13.1        HDF5Array_1.21.0           
##  [3] rhdf5_2.37.0                DelayedArray_0.19.1        
##  [5] NewWave_1.3.0               mclust_5.4.7               
##  [7] ggplot2_3.3.5               Rtsne_0.15                 
##  [9] irlba_2.3.3                 Matrix_1.3-4               
## [11] splatter_1.17.1             SingleCellExperiment_1.15.1
## [13] SummarizedExperiment_1.23.1 Biobase_2.53.0             
## [15] GenomicRanges_1.45.0        GenomeInfoDb_1.29.3        
## [17] IRanges_2.27.0              S4Vectors_0.31.0           
## [19] BiocGenerics_0.39.1         MatrixGenerics_1.5.1       
## [21] matrixStats_0.60.0         
## 
## loaded via a namespace (and not attached):
##  [1] colorspace_2.0-2              ellipsis_0.3.2               
##  [3] rprojroot_2.0.2               XVector_0.33.0               
##  [5] fs_1.5.0                      farver_2.1.0                 
##  [7] bit64_4.0.5                   interactiveDisplayBase_1.31.0
##  [9] AnnotationDbi_1.55.1          fansi_0.5.0                  
## [11] cachem_1.0.5                  knitr_1.33                   
## [13] jsonlite_1.7.2                dbplyr_2.1.1                 
## [15] png_0.1-7                     shiny_1.6.0                  
## [17] BiocManager_1.30.16           compiler_4.1.0               
## [19] httr_1.4.2                    backports_1.2.1              
## [21] assertthat_0.2.1              fastmap_1.1.0                
## [23] later_1.2.0                   BiocSingular_1.9.1           
## [25] htmltools_0.5.1.1             tools_4.1.0                  
## [27] rsvd_1.0.5                    gtable_0.3.0                 
## [29] glue_1.4.2                    GenomeInfoDbData_1.2.6       
## [31] dplyr_1.0.7                   rappdirs_0.3.3               
## [33] Rcpp_1.0.7                    jquerylib_0.1.4              
## [35] pkgdown_1.6.1                 Biostrings_2.61.1            
## [37] vctrs_0.3.8                   rhdf5filters_1.5.0           
## [39] ExperimentHub_2.1.4           xfun_0.24                    
## [41] stringr_1.4.0                 beachmat_2.9.0               
## [43] mime_0.11                     lifecycle_1.0.0              
## [45] AnnotationHub_3.1.4           zlibbioc_1.39.0              
## [47] scales_1.1.1                  ragg_1.1.3                   
## [49] promises_1.2.0.1              parallel_4.1.0               
## [51] yaml_2.2.1                    curl_4.3.2                   
## [53] memoise_2.0.0                 sass_0.4.0                   
## [55] stringi_1.7.3                 RSQLite_2.2.7                
## [57] BiocVersion_3.14.0            highr_0.9                    
## [59] desc_1.3.0                    ScaledMatrix_1.1.0           
## [61] checkmate_2.0.0               filelock_1.0.2               
## [63] BiocParallel_1.27.2           rlang_0.4.11                 
## [65] pkgconfig_2.0.3               systemfonts_1.0.2            
## [67] bitops_1.0-7                  evaluate_0.14                
## [69] lattice_0.20-44               purrr_0.3.4                  
## [71] Rhdf5lib_1.15.2               labeling_0.4.2               
## [73] bit_4.0.4                     tidyselect_1.1.1             
## [75] magrittr_2.0.1                R6_2.5.0                     
## [77] generics_0.1.0                DBI_1.1.1                    
## [79] pillar_1.6.2                  withr_2.4.2                  
## [81] SharedObject_1.7.0            KEGGREST_1.33.0              
## [83] RCurl_1.98-1.3                tibble_3.1.3                 
## [85] crayon_1.4.1                  utf8_1.2.2                   
## [87] BiocFileCache_2.1.1           rmarkdown_2.9                
## [89] locfit_1.5-9.4                grid_4.1.0                   
## [91] blob_1.2.2                    digest_0.6.27                
## [93] xtable_1.8-4                  httpuv_1.6.1                 
## [95] textshaping_0.3.5             munsell_0.5.0                
## [97] bslib_0.2.5.1</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Federico Agostinis.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
